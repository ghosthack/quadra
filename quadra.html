<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="UTF-8">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<title>quadra</title>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51903062-1', 'ghosthack.com');
  ga('send', 'pageview');

</script>

<script type="text/javascript">
console.log("Welcome!");

var api = {
  level: 1,
  lines: 0,
  score: 0,
  initialDelay: 400,
  delay: 400,
  size: 20,
  paused: false,
  over: false,
  timeout: null,
  context: null,
  base: 10,
  height: 25,
  space: [],
  spawner: {newFigure: null},
  position: {x:0, y:0},
  rotation: 0,
  type: 0,
  nextType: null,
//  typeColor: ["pink", "cyan", "red", "yellow", "blue", "orange", "green", "black"],
//  typeColor: ["silver","silver","silver","silver","silver","silver","silver","silver",],
  typeColor: ["gray","gray","gray","gray","gray","gray","gray","gray",],
  figure: null,
  figures: [],
  tick: null,
  moveLeft: null,
  moveRight: null,
  moveDown: null,
  rotateLeft: null,
  rotateRight: null,
  loop: null,
  gx: null,
  gy: null,
  checkPoints: null
};

api.figures = [
  [ function(x,y) { return [[x,y],[x+1,y+1],[x+1,y+0],[x+0,y+1]]; },
    function(x,y) { return [[x,y],[x+1,y+1],[x+1,y+0],[x+0,y+1]]; },
    function(x,y) { return [[x,y],[x+1,y+1],[x+1,y+0],[x+0,y+1]]; },
    function(x,y) { return [[x,y],[x+1,y+1],[x+1,y+0],[x+0,y+1]]; },
  ],
  [ function(x,y) { return [[x,y],[x-1,y+0],[x+1,y+0],[x+1,y+1]]; },
    function(x,y) { return [[x,y],[x+0,y-1],[x+0,y+1],[x-1,y+1]]; },
    function(x,y) { return [[x,y],[x-1,y+0],[x+1,y+0],[x-1,y-1]]; },
    function(x,y) { return [[x,y],[x+0,y-1],[x+0,y+1],[x+1,y-1]]; },
  ],
  [ function(x,y) { return [[x,y],[x+0,y-1],[x+0,y+1],[x+0,y+2]]; },
    function(x,y) { return [[x,y],[x+1,y+0],[x-1,y+0],[x-2,y+0]]; },
    function(x,y) { return [[x,y],[x+0,y-1],[x+0,y+1],[x+0,y-2]]; },
    function(x,y) { return [[x,y],[x+1,y+0],[x-1,y+0],[x+2,y+0]]; },
  ],
  //T
  [ function(x,y) { return [[x,y],[x-1,y+0],[x+1,y+0],[x+0,y+1]]; },
    function(x,y) { return [[x,y],[x+0,y-1],[x+0,y+1],[x-1,y+0]]; },
    function(x,y) { return [[x,y],[x-1,y+0],[x+1,y+0],[x+0,y-1]]; },
    function(x,y) { return [[x,y],[x+0,y-1],[x+0,y+1],[x+1,y+0]]; },
  ],
  //L
  [ function(x,y) { return [[x,y],[x-1,y+0],[x+1,y+0],[x+1,y-1]]; },
    function(x,y) { return [[x,y],[x+0,y-1],[x+0,y+1],[x+1,y+1]]; },
    function(x,y) { return [[x,y],[x-1,y+0],[x+1,y+0],[x-1,y+1]]; },
    function(x,y) { return [[x,y],[x+0,y-1],[x+0,y+1],[x-1,y-1]]; },
  ],
  //S
  [ function(x,y) { return [[x,y],[x+0,y+1],[x-1,y+1],[x+1,y+0]]; },
    function(x,y) { return [[x,y],[x-1,y-1],[x-1,y+0],[x+0,y+1]]; },
    function(x,y) { return [[x,y],[x+0,y+1],[x-1,y+1],[x+1,y+0]]; },
    function(x,y) { return [[x,y],[x-1,y-1],[x-1,y+0],[x+0,y+1]]; },
  ],
  //Z
  [ function(x,y) { return [[x,y],[x+1,y+1],[x+0,y+1],[x-1,y+0]]; },
    function(x,y) { return [[x,y],[x+0,y+1],[x+1,y+0],[x+1,y-1]]; },
    function(x,y) { return [[x,y],[x+1,y+1],[x+0,y+1],[x-1,y+0]]; },
    function(x,y) { return [[x,y],[x+0,y+1],[x+1,y+0],[x+1,y-1]]; },
  ],
];

api.rotations = [1,2,3,0];

api.nextRotation = function() {
  return api.rotations[api.rotation];
}

api.randomFigure = function() {
  return Math.floor(7*Math.random());
};

api.spawner.newFigure = function() {
  //pick a random figure!
  api.type = api.nextType;
  api.nextType = api.randomFigure();
  api.figure = api.figures[api.type][0];
  //place it in line 0, 50%
  api.position.x = api.base/2-1;
  api.position.y = 0;
  //rotation 0
  api.rotation = 0;

  // redraw next.
}

api.nextPoints = function(x, y) {
  if(api.nextType == null) return [];
  return api.figures[api.nextType][0](x, y);
}

api.clearPoint = function(x, y) {
  api.context.clearRect(x*api.size, y*api.size, api.size, api.size);
}

api.paintArea = function(x, y, sx, sy, color) {
  api.context.fillStyle = color;
  api.context.fillRect(x*api.size, y*api.size, sx*api.size, sy*api.size);
}

api.drawPoint = function(x, y, c) {
  api.context.fillStyle = api.typeColor[c];
  api.context.fillRect(x*api.size, y*api.size, api.size, api.size);
}

api.reDrawLines = function() {
  for(var j=0; j<api.height; j++) {
    for(var i=0; i<api.base; i++) {
      var p = api.space[i][j];
      if(p == null)  {
        api.clearPoint(i,j);
      } else {
        api.drawPoint(i,j,p);
      }
    }
  }
}

api.erase = function() {
  api.forPoints2(api.points(), function(p) {
    api.context.clearRect(p[0]*api.size, p[1]*api.size, api.size, api.size);
  });
}

api.draw = function() {
  api.context.fillStyle = api.typeColor[api.type];
  api.forPoints2(api.points(), function(p) {
    api.context.fillRect(p[0]*api.size, p[1]*api.size, api.size, api.size);
  });
}

api.reDrawNext = function() {
  api.clear(api.base+1, 0, 5, 4);
  api.context.fillStyle = api.typeColor[api.nextType];
  api.forPoints2(api.nextPoints(api.base+3,1), function(p) {
    api.context.fillRect(p[0]*api.size, p[1]*api.size, api.size, api.size);
  });
}

api.gx = function() {
  return api.position.x * api.size;
}
api.gy = function() {
  return api.position.y * api.size;
}

api.initialize = function() {
  api.clearTimeout();
  api.clear(0, 0, api.base, api.height);
  api.over = false;
  api.paused = false;
  api.score = 0;
  api.lines = 0;
  api.level = 1;
  api.delay = api.initialDelay;
  api.type = api.randomFigure();
  api.nextType = api.randomFigure();
  for(var i=0; i<api.base; i++) {
    api.space[i] = [];
    for(var j=0; j<api.height; j++) {
      api.space[i][j] = null;
    }
  }
  api.spawner.newFigure();
  api.loop();
  api.paintArea(api.base, 0, 6, api.height, "silver");
  api.reDrawScore();
  api.reDrawNext();
}

api.tick = function() {
  api.moveDown();
}

api.forPoints2 = function(points, callback) {
  for(var i=0; i<points.length; i++) {
    callback(points[i]);
  }
}

api.checkPoints2 = function(points, callback) {
  for(var i=0; i<points.length; i++) {
    if(!callback(points[i])) {
      return false;
    }
  }
  return true;
}

api.points = function() {
  if(api.figure == null) return [];
  return api.figure(api.position.x, api.position.y);
}

api.moveLeft = function() {
  if(api.checkPoints2(api.points(), function(p) {
    return ( (p[0] > 0)
             && (api.space[p[0]-1][p[1]] == null)
           );
  } )) {
    api.erase();
    api.position.x = api.position.x-1;
    api.draw();
  }
};

api.moveRight = function() {
  if(api.checkPoints2(api.points(), function(p) {
    return ( (p[0]+1 < api.base)
             && (api.space[p[0]+1][p[1]] == null)
           ); } )) {
    api.erase();
    api.position.x = api.position.x+1;
    api.draw();
  }
}

api.canMoveDown = function() {
  return api.checkPoints2(api.points(), function(p) {
    return(
      (api.space[p[0]][p[1]+1] == null) && (p[1]+1 < api.height)); } );

}

api.canAssignSpace = function() {
  return(api.checkPoints2(api.points(), function(p) {
    return(api.space[p[0]][p[1]] == null);
  }));
}

api.assignSpace = function() {
  api.forPoints2(api.points(), function(p) {
    api.space[p[0]][p[1]] = api.type;
  });
}

api.moveDown = function() {
  if(api.canMoveDown()) {
    api.erase();
    api.position.y = api.position.y+1;
    api.draw();
    return true;
  } else {
    if(api.canAssignSpace()) {
      api.assignSpace();
      api.processLines();
      api.spawner.newFigure();
      api.reDrawNext();
      if(api.canAssignSpace()) {
        api.draw();
      }
    } else {
      console.log("Game Over")
      api.over = true;
      api.pause();
    }
    return false;
  }
  // TODO draw should be here
}

api.moveDownLoop = function() {
  while(api.moveDown());
}

api.resetLine = function(y) {
  for(var i=0; i<api.base; i++) {
    api.space[i][y] = null;
  }
}

api.copyLine = function(origin, target) {
  for(var i=0; i<api.base; i++) {
    api.space[i][target] = api.space[i][origin];
  }
}

api.checkLine = function(j) {
  for(var i=0; i<api.base; i++) {
    if(api.space[i][j] == null) {
      return false;
    }
  }
  return true;
}

api.processLines = function() {
  var last = api.height-1;
  var deltas = [];
  var delta = 0;
  for(var y=last; y>=0; y--) {
    var complete = api.checkLine(y);
    if(complete) {
      deltas[y] = 0;
      delta++;
    } else {
      deltas[y] = delta;
    }
  }
  if(delta > 0) {
    for(var y=last; y>=0; y--) {
      var inc = deltas[y];
      if(inc > 0) {
        api.copyLine(y, y+inc);
      }
    }
    for(var y=0; y<delta; y++) {
      api.resetLine(y);
    }
    api.reDrawLines();
    api.score += Math.pow(delta,4);
    api.lines += delta;
    api.level = Math.ceil(api.lines / 4);
    api.reDrawScore();
  }
}

api.clear = function(x,y,dx,dy) {
  api.context.clearRect(x*api.size, y*api.size, dx*api.size, dy*api.size);
}

api.reDrawScore = function() {
  api.clear(api.base+1, 5, 5, 3);
  api.clear(api.base+1, 4+5, 5, 3);
  api.clear(api.base+1, 8+5, 5, 3);

  api.context.fillStyle = "silver";
  var size = 6;
  api.context.font = "bold 17px sans-serif";
  api.context.fillText("SCORE", (2+api.base)*api.size, 6*api.size+size);
  api.context.fillText(api.score, (2+api.base)*api.size, 7*api.size+size);
  api.context.fillText("LINES", (2+api.base)*api.size, (4+6)*api.size+size);
  api.context.fillText(api.lines, (2+api.base)*api.size, (4+7)*api.size+size);
  api.context.fillText("LEVEL", (2+api.base)*api.size, (8+6)*api.size+size);
  api.context.fillText(api.level, (2+api.base)*api.size, (8+7)*api.size+size);
}

api.points2 = function(f) {
  if(f == null) return [];
  return f(api.position.x, api.position.y);
}

api.canRotateRight = function(f) {
  return api.checkPoints2(api.points2(f), function(p) {
    return( true
      && (p[1] < api.height)
      && (p[0] < api.base)
      && (p[0] >= 0)
      && (api.space[p[0]][p[1]] == null)
    ); } );
}

api.rotateRight = function() {
  var nextRotation = api.nextRotation();
  var nextFigure = api.figures[api.type][nextRotation];
  if(api.canRotateRight(nextFigure)) {
    api.erase();
    api.rotation = nextRotation;
    api.figure = nextFigure;
    api.draw();
  }
}

api.loop = function() {
  api.tick();
  if(!api.over && !api.paused) {
    api.schedule();
  }
}

api.schedule = function() {
  api.timeout = window.setTimeout(function() {
    api.loop();
  }, (api.delay-api.level*10) );
}

api.clearTimeout = function() {
  if(api.timeout != null) {
    window.clearTimeout(api.timeout);
    api.timeout = null;
  }
}

api.pause = function() {
  api.paused = true;
  api.clearTimeout();
}

api.resume = function() {
  api.paused = false;
  api.schedule();
}

api.pauseOrResume = function() {
  if(!api.paused) {
    api.pause();
  } else {
    api.resume();
  }
}

function touchEvent(event) {
  if(event) {
    if(event.x && event.y) {
      if(event.y > window.innerHeight/2) {
        if(event.x > window.innerWidth/2) {
          api.moveRight();
        } else {
          api.moveLeft();
        }
      } else {
        api.rotateRight();
      }
      event.preventDefault();

    } else if(event.touches) {
      var touch = event.touches[0];
      if(touch.pageY > window.innerHeight/2) {
        if(touch.pageX > window.innerWidth/2) {
          api.moveRight();
        } else {
          api.moveLeft();
        }
      } else {
        api.rotateRight();
      }
      event.preventDefault();
      //event.stopPropagation();
    }
  } else {
    //doesn't happen
  }
}

function main() {
  var canvas = document.getElementById("canvas2d");
  var context = canvas.getContext("2d");
  document.body.addEventListener('touchstart', touchEvent, false);
  document.body.addEventListener('click', touchEvent, false);

  var w = window.innerWidth-10;
  var h = window.innerHeight-10;
  var base = api.base + 6;
  //var base = api.base;
  var s1 = Math.floor(w/base);
  var s2 = Math.floor(h/api.height);
  api.size = Math.min(s1, s2);
  canvas.width = base * api.size;
  canvas.height = api.height * api.size;
  api.context = context;
  api.initialize();
}

function keyAction() {
  switch(event.keyCode) {
    case 81:
      api.moveDownLoop();
      break;
    case 80:
      api.pauseOrResume();
      break;
    case 37:
      api.moveLeft();
      break;
    case 39:
      api.moveRight();
      break;
    case 40:
      api.moveDown();
      break;
    case 82:
      api.initialize();
      break;
    case 38:
    case 32:
      api.rotateRight();
      break;
    default: console.log(event.keyCode);
  }
}

</script>
</head>
<body id="body2d" onload="main()" onkeydown="keyAction()" style="padding: 0; margin: 0; background: silver">
<div id="div2d" style="position:absolute; top:0; left:0;"></div>
<canvas id="canvas2d" width="1" height="1" style="border: 0; padding: 0; margin: auto; display: block; background-color: white;">
</canvas>
</body>
</html>
